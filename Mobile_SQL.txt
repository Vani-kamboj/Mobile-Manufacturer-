/*Q1. SELECT ALL STATES WHERE CUSTOMERS HAVE BOUGHT CELLPHONES FROM 2005 TILL TODAY.*/
SELECT DISTINCT(A.STATE) FROM DIM_LOCATION as A
LEFT JOIN FACT_TRANSACTIONS AS B
ON A.IdLocation = B.IdLocation
WHERE YEAR(B.DATE) >= 2005


/*Q2. WHAT STATE IN THE US IS BUYING FROM 'SAMSUMG' CELL PHONES.*/
SELECT DISTINCT(C.STATE) FROM
DIM_MODEL AS A 
LEFT JOIN FACT_TRANSACTIONS AS B
ON A.IdModel = B.IdModel
LEFT JOIN DIM_LOCATION AS C
ON B.IdLocation = C.IdLocation 
LEFT JOIN DIM_MANUFACTURER AS D
ON A.IDManufacturer = D.IDManufacturer
WHERE D.Manufacturer_Name = 'SAMSUNG' AND C.Country = 'US'



/*Q3. SHOW NUMBER OF TRANSACTION FOR EACH MODEL PER ZIP CODE PER STATE.*/
SELECT COUNT(*) AS NO_TRANSACTIONS
FROM ( SELECT DISTINCT A.IDMODEL, B.ZIPCODE, B.STATE 
FROM FACT_TRANSACTIONS as A
   LEFT JOIN DIM_LOCATION AS B
 ON A.IdLocation = B.IdLocation) AS T
		
	 


/*Q4. SHOW THE CHEAPEST CELLPHONE*/
   SELECT MODEL_NAME FROM DIM_MODEL 
	WHERE UNIT_PRICE IN (SELECT MIN(UNIT_PRICE ) FROM DIM_MODEL)



 /*Q5. FIND OUT THE AVERAGE PRICE FOR EACH MODEL IN THE TOP 5 MANUFACTURERS IN TERMS OF SALES QUANITY  AND ORDER BY AVERAGE PRICE?*/
   SELECT A.MODEL_NAME, round(AVG(B.TOTALPRICE),2) AS AVERAGE_PRICE 
  FROM DIM_MODEL A LEFT JOIN FACT_TRANSACTIONS B
	ON A.IDModel = B.IDModel
	LEFT JOIN DIM_MANUFACTURER C
	ON A.IDManufacturer = C.IDManufacturer 
	WHERE C.Manufacturer_Name IN  (
	SELECT TOP 5 (C.Manufacturer_Name) 
    FROM DIM_MODEL A LEFT JOIN FACT_TRANSACTIONS B 
	ON A.IDModel = B.IDModel
	LEFT JOIN DIM_MANUFACTURER C
	ON A.IDManufacturer = C.IDManufacturer 
	GROUP BY C.Manufacturer_Name
	ORDER BY SUM(B.Quantity) DESC)
	GROUP BY A.Model_Name	
	ORDER BY AVG(B.TOTALPRICE) DESC

 /*Q6. LIST THE NAME OF CUSTOMERS AND AVERAGE AMOUNT SPEND IN 2009, WHERE THE AVERAGE IS HIGHER THAN 500.*/ 
 SELECT A.CUSTOMER_NAME, AVG(B.TotalPrice) AS AMT_SPENT 
 FROM	DIM_CUSTOMER A
		INNER JOIN FACT_TRANSACTIONS B ON A.IdCustomer = B.IdCustomer
		WHERE YEAR(B.DATE) = 2009
		GROUP BY A.Customer_Name
		HAVING AVG(B.TOTALPRICE) > 500
		
 /*Q7. LIST IF THERE IS ANY MODEL THAT WAS IN TOP 5 IN TERMS OF QUANTITY , SIMULTANEOSLY  IN 2008,2009 and 2010 */
SELECT * FROM 
		(SELECT * FROM 
		(SELECT TOP 5 A.Model_Name FROM DIM_MODEL A 
		LEFT JOIN FACT_TRANSACTIONS B
		ON A.IdModel = B.IdModel 
		WHERE YEAR(DATE) = 2008
		GROUP BY A.Model_Name
	    ORDER BY SUM(B.Quantity) DESC)X
   UNION ALL
		SELECT * FROM 
		(SELECT TOP 5 A.Model_Name  FROM DIM_MODEL A
		LEFT JOIN FACT_TRANSACTIONS B
		ON A.IdModel = B.IdModel 
        WHERE YEAR(DATE) = 2009
		GROUP BY A.Model_Name
	    ORDER BY SUM(B.Quantity) DESC)X
  UNION ALL
	    SELECT * FROM 
		(SELECT TOP 5 A.Model_Name   FROM DIM_MODEL A
		LEFT JOIN FACT_TRANSACTIONS B
		ON A.IdModel = B.IdModel 
		WHERE YEAR(DATE) = 2010
		GROUP BY A.Model_Name
		ORDER BY SUM(B.Quantity) DESC)X
		) as tt
		GROUP BY Model_Name
		HAVING COUNT(MODEL_NAME) = 3


 /*Q8. SHOW THE MANUFACTURER WITH 2ND TOP SALES IN THE YEAR OF 2009 AND THE MANUFACTURER  WITH THE 2ND TOP SALES IN 2010.*/
       SELECT DISTINCT(YEAR(C.DATE)) AS YEAR, A.MANUFACTURER_NAME
		FROM DIM_MANUFACTURER A 
		LEFT JOIN DIM_MODEL B
		ON A.IdManufacturer = B.IdManufacturer
	    LEFT JOIN FACT_TRANSACTIONS C
		ON B.IdModel = C.IdModel
		WHERE 
		(YEAR(C.DATE) = 2009 )
	   AND C.TotalPrice =  (SELECT MAX(TotalPrice) 
	   FROM FACT_TRANSACTIONS WHERE YEAR(DATE) = 2009 AND TotalPrice NOT IN(SELECT MAX(TotalPrice) 
	   FROM FACT_TRANSACTIONS WHERE YEAR(DATE) = 2009)  )
        OR(YEAR(C.DATE) = 2010) AND C.TotalPrice =  (SELECT MAX(TotalPrice) 
		 FROM FACT_TRANSACTIONS WHERE YEAR(DATE) = 2010 AND TotalPrice NOT IN(SELECT MAX(TotalPrice) 
		 FROM FACT_TRANSACTIONS WHERE YEAR(DATE) = 2010)  )
		


 /*Q9. SHOW THE MANUFACTURERS WHO SOLD CELLPHONE IN 2010 BUT DIDN'T IN 2009.*/
       SELECT DISTINCT(A.MANUFACTURER_NAME) 
		FROM DIM_MANUFACTURER A 
		INNER JOIN DIM_MODEL B
	   ON A.IdManufacturer = B.IdManufacturer 
		INNER JOIN FACT_TRANSACTIONS C
		ON B.IdModel = C.IdModel
		WHERE YEAR(C.DATE) = 2010 AND YEAR(C.DATE) != 2009



 /*Q10. FIND TOP 100 CUSTOMERS AND AND THEIR AVERAGE SPEND, AVERAGE QUANTITY BY EACH YEAR. ALSO FIND THE PERCENTAGE IN THEIR SPEND*/
       SELECT TOP 100 A.CUSTOMER_NAME 
	,	AVG(CASE WHEN YEAR(B.DATE) = 2003 THEN (B.TOTALPRICE) END) AS AVG_SPENT_2003
	,	AVG(CASE WHEN YEAR(B.DATE) = 2003 THEN (B.QUANTITY) END) AS AVG_QUANTITY_2003
	,	AVG(CASE WHEN YEAR(B.DATE) = 2004 THEN (B.TOTALPRICE) END) AS AVG_SPENT_2004
	,	AVG(CASE WHEN YEAR(B.DATE) = 2004 THEN (B.QUANTITY) END) AS AVG_QUANTITY_2004
	,	AVG(CASE WHEN YEAR(B.DATE) = 2005 THEN (B.TOTALPRICE) END) AS AVG_SPENT_2005
	,	AVG(CASE WHEN YEAR(B.DATE) = 2005 THEN (B.QUANTITY) END) AS AVG_QUANTITY_2005
	,	AVG(CASE WHEN YEAR(B.DATE) = 2006 THEN (B.TOTALPRICE) END) AS AVG_SPENT_2006
	,	AVG(CASE WHEN YEAR(B.DATE) = 2016 THEN (B.QUANTITY) END) AS AVG_QUANTITY_IN_2006
	,	AVG(CASE WHEN YEAR(B.DATE) = 2007 THEN (B.TOTALPRICE) END) AS AVG_SPENT_2007
	,	AVG(CASE WHEN YEAR(B.DATE) = 2007 THEN (B.QUANTITY) END) AS AVG_QUANTITY_2007
	,	AVG(CASE WHEN YEAR(B.DATE) = 2008 THEN (B.TOTALPRICE) END) AS AVG_SPENT_2008
	,	AVG(CASE WHEN YEAR(B.DATE) = 2008 THEN (B.QUANTITY) END) AS AVG_QUANTITY_2008
	,	AVG(CASE WHEN YEAR(B.DATE) = 2009 THEN (B.TOTALPRICE) END) AS AVG_SPENT_2009
	,	AVG(CASE WHEN YEAR(B.DATE) = 2009 THEN (B.QUANTITY) END) AS AVG_QUANTITY_2009
	,	AVG(CASE WHEN YEAR(B.DATE) = 2010 THEN (B.TOTALPRICE) END) AS AVG_SPENT_2010
	,	AVG(CASE WHEN YEAR(B.DATE) = 2010 THEN (B.QUANTITY) END) AS AVG_QUANTITY_2010												
	   FROM DIM_CUSTOMER A 
	   LEFT JOIN FACT_TRANSACTIONS B
	   ON A.IdCustomer = B.IdCustomer
	   GROUP BY  A.CUSTOMER_NAME
	   ORDER BY SUM(B.TOTALPRICE)